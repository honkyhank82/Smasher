import { Body, Controller, Post, Get, UseGuards, BadRequestException } from '@nestjs/common';
import { AuthGuard } from '@nestjs/passport';
import { MediaService } from './media.service';
import { CurrentUser } from '../auth/current-user.decorator';

@Controller('media')
export class MediaController {
  constructor(private readonly mediaService: MediaService) {}

  @Post('signed-upload')
  @UseGuards(AuthGuard('jwt'))
  async createSignedUpload(
    @CurrentUser() user: { userId: string },
    @Body() body: { fileName: string; fileType: string; mediaType?: 'photo' | 'video' }
  ) {
    // Validate file type
    const isVideo = body.mediaType === 'video' || body.fileType.startsWith('video/');
    const isPhoto = body.mediaType === 'photo' || body.fileType.startsWith('image/');
    
    if (!isVideo && !isPhoto) {
      throw new BadRequestException('Only images and videos are allowed');
    }

    // Generate unique key for the file
    const timestamp = Date.now();
    const mediaFolder = isVideo ? 'videos' : 'photos';
    const key = `users/${user.userId}/${mediaFolder}/${timestamp}-${body.fileName}`;
    const result = await this.mediaService.createSignedUploadUrl(key, body.fileType);
    return {
      uploadUrl: result.url,
      fileKey: result.key,
      mediaType: isVideo ? 'video' : 'photo',
    };
  }

  @Post('signed-download')
  createSignedDownload(@Body() dto: CreateSignedDownloadDto) {
    return this.mediaService.createSignedDownloadUrl(dto.key);
  }

  @Post('upload')
  @UseGuards(AuthGuard('jwt'))
  async uploadMedia(
    @CurrentUser() user: { userId: string },
    @Body() body: { fileName: string; fileType: string; mediaType: 'photo' | 'video'; fileData: string }
  ) {
    return this.mediaService.uploadMediaBase64(user.userId, body.fileName, body.fileType, body.mediaType, body.fileData);
  }

  @Post('confirm-upload')
  @UseGuards(AuthGuard('jwt'))
  async confirmUpload(
    @CurrentUser() user: { userId: string },
    @Body() body: { fileKey: string; fileType: string; mediaType: 'photo' | 'video' }
  ) {
    return this.mediaService.createMediaRecord(user.userId, body.fileKey, body.fileType, body.mediaType);
  }

  @Post('set-profile-picture')
  @UseGuards(AuthGuard('jwt'))
  async setProfilePicture(
    @CurrentUser() user: { userId: string },
    @Body() body: { mediaId: string }
  ) {
    return this.mediaService.setProfilePicture(user.userId, body.mediaId);
  }

  @Post('delete')
  @UseGuards(AuthGuard('jwt'))
  async deleteMedia(
    @CurrentUser() user: { userId: string },
    @Body() body: { mediaId: string }
  ) {
    return this.mediaService.deleteMedia(user.userId, body.mediaId);
  }

  @Get('my-media')
  @UseGuards(AuthGuard('jwt'))
  async getMyMedia(@CurrentUser() user: { userId: string }) {
    return this.mediaService.getUserMedia(user.userId);
  }
}
