name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Setup Expo CLI
        run: npm install -g @expo/cli

      - name: Install EAS CLI
        run: npm install -g eas-cli

      - name: Install dependencies
        run: cd app-rn && npm install

      - name: Build APK and download artifact
        run: |
          sudo apt-get update && sudo apt-get install -y jq
          cd app-rn
          # Run EAS build in non-interactive mode and output JSON
          BUILD_JSON="$(eas build --platform android --profile production --non-interactive --json)"
          echo "$BUILD_JSON" > build-output.json
          # Extract artifact URL from build array structure
          echo "Build JSON structure:"
          echo "$BUILD_JSON" | jq 'type'
          echo "First few elements:"
          echo "$BUILD_JSON" | jq '.[0:3]'
          APK_URL="$(echo "$BUILD_JSON" | jq -r '.[0].artifacts[0].applicationArchiveUrl // empty')"
          mkdir -p ../build
          if [ -z "$APK_URL" ] || [ "$APK_URL" = "null" ]; then
            echo "Failed to find APK URL in build output" >&2
            cat build-output.json >&2
            exit 1
          fi
          echo "Downloading APK to ../build/app.apk"
          curl -L -o ../build/app.apk "$APK_URL"
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: Upload to Google Play (fastlane) if configured
        run: |
          if [ -n "${{ secrets.GOOGLE_PLAY_JSON }}" ]; then
            echo "Writing Google Play service account key..."
            echo "${{ secrets.GOOGLE_PLAY_JSON }}" > ./google-play-service-account.json
            sudo gem install fastlane --no-document
            cd app-rn
            # Choose the first artifact in ../build (usually .aab or .apk)
            ART=$(ls ../build | head -n1 || true)
            if [ -z "$ART" ]; then
              echo "No artifact found in ../build, skipping Play upload"
            else
              echo "Found artifact: $ART"
              if echo "$ART" | grep -q "\.aab$"; then
                echo "Uploading AAB to Play Store via fastlane"
                fastlane deploy json_key: '../google-play-service-account.json', aab: "../build/$ART"
              else
                echo "Uploading APK to Play Store via fastlane (using aab param if needed)"
                fastlane deploy json_key: '../google-play-service-account.json', aab: "../build/$ART"
              fi
            fi
          else
            echo "GOOGLE_PLAY_JSON secret not set â€” skipping Play Store upload"
          fi

      - name: Set package versions to tag
        id: set-versions
        run: |
          TAG=${GITHUB_REF##*/}
          TAG=${TAG#v}
          echo "TAG=$TAG" >> $GITHUB_ENV
          echo "Setting package.json versions to $TAG"
          node ./scripts/set-version-to-tag.js "$TAG"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add package.json server/package.json app-rn/package.json app-web/package.json || true
          git commit -m "chore(release): set versions to $TAG [skip ci]" || echo "No version changes to commit"

      - name: Create version bump Pull Request (safe for protected branches)
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: release/versions-${{ env.TAG }}
          title: "chore(release): set versions to ${{ env.TAG }}"
          body: "Auto-updated package.json versions from tag ${{ env.TAG }}"
          labels: "automated,release"
          base: ${{ github.event.repository.default_branch }}
          commit-message: "chore(release): set versions to ${{ env.TAG }} [skip ci]"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          generate_release_notes: true
          files: ./build/**/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Optionally run production DB seed
        if: always()
        run: |
          echo "Preparing to run production seed (will abort unless SEED_CONFIRM=true is provided)"
          npm ci --prefix server
          # Run production seed; SEED_CONFIRM must be provided via secrets for safety
          cd server
          export SEED_CONFIRM="${{ secrets.SEED_CONFIRM }}"
          export RESEND_API_KEY="${{ secrets.RESEND_API_KEY }}"
          export SEED_NOTIFY_TO="${{ secrets.SEED_NOTIFY_TO }}"
          export DATABASE_URL="${{ secrets.DATABASE_URL }}"
          export NODE_ENV=production
          npm run seed:profiles:prod || echo "Seed step exited with non-zero status (check logs)"
